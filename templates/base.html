{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Black Lodge</title>
        <link rel="icon" type="image/x-icon" href="{% static "assets/favicon.ico" %}" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="{% static "css/styles.css" %}" rel="stylesheet" />
        <style>
            .options-card {
                background: white;
                border: 1px solid #ddd;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }
            
            .dropdown-item {
                display: block;
                padding: 5px 10px;
                text-decoration: none;
            }
            
            .dropdown-item:hover {
                background-color: #f8f9fa;
            }
            #notificationDropdown {
                width: 100vw;
                max-width: 400px;
                box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
                border-radius: 0.5rem;
                z-index: 1050;
                right: 0;
                left: auto;
            }
            
            #notificationsListWrapper {
                max-height: 60vh;
                overflow-y: auto;
            }
            
            .notification-item {
                padding: 0.75rem 1rem;
                border-bottom: 1px solid #f0f0f0;
                white-space: normal;
                word-wrap: break-word;
            }
            
            .notification-item.unread {
                background-color: #f8f9fa;
                font-weight: 500;
            }
            
            @media (max-width: 576px) {
                    #notificationDropdown {
                        width: 90vw;
                        left: 5vw;
                        right: auto;
                    }
                }

        
        </style>
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light" id="mainNav">
            <div class="container px-4 px-lg-5">
                 {% if user.is_authenticated %}
                <a class="navbar-brand" href="{% url 'create-story' %}">Start writing...</a>
                {% else %}
                    <!-- Show these links when user is not logged in -->
                    <a class="navbar-brand" href="{% url 'login' %}">Login</a>
                    <a class="navbar-brand" href="{% url 'reg-page' %}">Register</a>
                {% endif %}
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto py-4 py-lg-0">
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="{% url 'home-page' %}">Home</a></li>
                        {% if user.is_authenticated %}
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="{% url 'profile' %}">View Profile</a></li>
                        {% endif %}
                        {% if user.is_authenticated %}
                           <li class="nav-item dropdown">
                              <a class="nav-link px-lg-3 py-3 py-lg-4 position-relative" href="#" id="notificationBell" role="button">
                                Notification
                              </a>
                            
                              <div id="notificationDropdown" class="dropdown-menu dropdown-menu-end p-2"
                                   style="min-width: 300px; max-height: 80vh; overflow-y: auto; display: none;">
                                <h6 class="dropdown-header">Notifications</h6>
                                      <div id="notificationsListWrapper" style="max-height: 60vh; overflow-y: auto;">
                                        <div id="notificationsList"></div>
                                      </div>
                                    <button id="markAllReadBtn" class="btn btn-sm btn-outline-secondary w-100 mt-2">
                                        Mark All as Read
                                    </button>
                              </div>
                            </li>                
                        {% endif %}

                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content-->
        {% block content %}
            
        {%endblock%}

        <!-- Footer-->
     <!-- Footer -->
        <footer class="py-5 bg-light" style="border-top: 1px solid #ddd;">
            <div class="container text-center">
                <p class="m-0 text-muted" style="font-size: 0.9rem;">&copy; Black Lodge.</p>
            </div>
        </footer>

        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="{% static "js/scripts.js" %}"></script>
    </body>
</html>
<script>
    // Options toggle functionality
    function toggleOptions(postId) {
        const card = document.getElementById(`optionsCard-${postId}`);
        // Close all other option cards first
        document.querySelectorAll('.options-card').forEach(el => {
            if (el.id !== `optionsCard-${postId}`) el.style.display = 'none';
        });
        // Toggle the current one
        card.style.display = card.style.display === 'none' ? 'block' : 'none';
    }

    // Close options cards when clicking anywhere else
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('options-toggle') && !e.target.closest('.options-card')) {
            document.querySelectorAll('.options-card').forEach(el => {
                el.style.display = 'none';
            });
        }
        

    const bell = document.getElementById('notificationBell');
    const dropdown = document.getElementById('notificationDropdown');
    const list = document.getElementById('notificationsList');
    let notificationsLoaded = false;

    // Load notifications on dropdown toggle
    bell.addEventListener('click', async (e) => {
        e.preventDefault();
        const isOpen = dropdown.style.display === 'block';
        dropdown.style.display = isOpen ? 'none' : 'block';

        if (!isOpen && !notificationsLoaded) {
            await loadNotifications();
        }
    });

    // Load notifications
    async function loadNotifications() {
        try {
            const response = await fetch('/api/notifications/', { credentials: 'include' });
            const notifications = await response.json();
            list.innerHTML = '';

            if (notifications.length === 0) {
                list.innerHTML = '<div class="dropdown-item text-muted">No notifications</div>';
                return;
            }

            notifications.forEach(notification => {
                const item = document.createElement('div');
                item.className = `dropdown-item notification-item ${notification.read ? '' : 'unread'}`;
                item.textContent = notification.message;
                list.appendChild(item);
            });

            // Add "Mark All as Read" button
           const markAllBtn = document.getElementById('markAllReadBtn');
            markAllBtn.addEventListener('click', async () => {
                await markAllAsRead();
                await loadNotifications(); // reload to refresh UI
            });

            notificationsLoaded = true;

        } catch (error) {
            console.error('Error loading notifications:', error);
            list.innerHTML = '<div class="dropdown-item text-danger">Error loading notifications</div>';
        }
    }

    // Mark all notifications as read
    async function markAllAsRead() {
        try {
            const response = await fetch('/api/notifications/', { credentials: 'include' });
            const notifications = await response.json();

            await Promise.all(
                notifications.filter(n => !n.read).map(n => markAsRead(n.id))
            );
        } catch (error) {
            console.error('Error marking all as read:', error);
        }
    }

    // Helper to mark individual notification as read
    async function markAsRead(notificationId) {
        try {
            await fetch(`/api/notifications/mark-read/${notificationId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'include'
            });
        } catch (error) {
            console.error(`Error marking notification ${notificationId} as read:`, error);
        }
    }

    // Helper to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!bell.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
});

</script>

