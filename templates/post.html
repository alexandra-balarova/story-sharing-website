{% extends 'base.html' %}
{% load static %}

{% block content %}

<header class="masthead" style="background-image: url('{% static "assets/img/library_wallpaper.jpg" %}')">
    <div class="container position-relative px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                <div class="post-heading">
                    <h1>{{ story.title }}</h1>
                    <span class="meta">
                        Posted by
                        {% if is_own_story %}
                            You on {{ story.created_at }} <a href="{% url 'edit-story' story.pk %}">- Edit story</a>
                        {% else %}
                            <a href="{% url 'user-profile' story.author.username %}">{{ story.author }}</a> on {{ story.created_at }}
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<article class="mb-4">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7" style="font-family: 'Segoe UI', system-ui, sans-serif;">
                <h5>Synopsis:</h5>
                <p class="subheading">{{ story.synopsis }}</p>

                <label for="chapterSelect"><strong>Select Chapter:</strong></label>
                <select id="chapterSelect" class="form-control" onchange="goToChapter(this)">
                    <option value="">Choose a Chapter</option>
                    {% for ch in story.chapters.all %}
                        {% if is_own_story %}
                            <option value="{{ ch.id }}" {% if chapter and ch.id == chapter.id %}selected{% endif %}>
                                {{ ch.title }}{% if not ch.public %} - private{% endif %}
                            </option>
                        {% else %}
                            {% if ch.public %}
                                <option value="{{ ch.id }}" {% if chapter and ch.id == chapter.id %}selected{% endif %}>
                                    {{ ch.title }}
                                </option>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </select>

                {% if chapter %}
                    <hr>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <h3>{{ chapter.title }}</h3>
                            {% if not chapter.public %}
                                <h6 style="margin: 0; font-weight: normal; font-size: 1rem; color: #666;">
                                    <img src="{% static 'assets/lock-icon.png' %}" width="25" height="25" alt="Private chapter">
                                </h6>
                            {% endif %}
                        </div>
                    </div>
                    <p>{{ chapter.content|linebreaks }}</p>

                    {% if next_chapter %}
                        <a href="?chapter={{ next_chapter.id }}" class="btn btn-primary mt-3">Next Chapter &rarr;</a>
                    {% else %}
                        <p class="mt-3"><em>You're at the end :(</em></p>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card-body" style="display:inline; margin-left: 120px">
        <!-- Like -->
        <form method="post" action="{% url 'likes' story.pk %}" style="display:inline">
            {% csrf_token %}
            <button type="submit" style="border:none; background:none;">
                {% if user.profile in story.liked_by.all %}
                    <img src="{% static 'assets/red-heart-icon-shape-illustration-free-vector.jpg' %}" width="32" height="32" alt="Liked">
                {% else %}
                    <img src="{% static 'assets/free-heart-icon-3510-thumb.png' %}" width="32" height="32" alt="Like">
                {% endif %}
            </button>
        </form>

        <!-- Bookmark -->
        <form method="post" action="{% url 'bookmarks' story.pk %}" style="display:inline">
            {% csrf_token %}
            <button type="submit" style="border:none; background:none;">
                {% if user.profile in story.bookmarked_by.all %}
                    <img src="{% static 'assets/bookmark-icon-vector-full.jpg' %}" width="32" height="32" alt="Bookmarked">
                {% else %}
                    <img src="{% static 'assets/bookmark-icon-vector-empty.jpg' %}" width="32" height="32" alt="Bookmark">
                {% endif %}
            </button>
        </form>

        <!-- Options -->
        <div style="position: relative; display: inline-block;">
            <button onclick="toggleOptions('{{ story.pk }}')" class="btn btn-sm btn-light" style="padding: 2px 8px;">⋯</button>
            <div id="optionsCard-{{ story.pk }}" class="card shadow mt-2"
                 style="width: 150px; display: none; position: absolute; right: 0; z-index: 1000;">
                <div class="card-body p-2">
                    {% if request.user == story.author %}
                        <h6><a href="{% url 'edit-story' story.pk %}" class="dropdown-item text-dark mb-1">Edit</a></h6>
                        <h6><a href="{% url 'delete' story.pk %}" class="dropdown-item text-danger mb-1">Delete</a></h6>
                    {% elif request.user.is_superuser %}
                        <h6><a href="{% url 'delete' story.pk %}" class="dropdown-item text-danger mb-1">Delete</a></h6>
                    {% endif %}
                    <h6><a href="{% url 'report' story.pk %}" class="dropdown-item mb-1">Report</a></h6>
                </div>
            </div>
        </div>
    </div>
</article>

<!-- Comments Section -->
<div class="container mt-4" style="font-family: 'Segoe UI', system-ui, sans-serif;">
    <h4>Comments</h4>
    <div class="card mb-4 p-4">
        {% if comments %}
            {% for comment in comments|slice:":3" %}
                <div class="card mb-3 p-3 position-relative">
                    <button onclick="toggleOptions('{{ comment.pk }}')" class="btn btn-sm btn-light"
                            style="position: absolute; top: 0.5rem; right: 0.5rem;">⋯</button>

                    <div id="optionsCard-{{ comment.pk }}" class="card shadow mt-2"
                         style="width: 150px; display: none; position: absolute; top: 2.5rem; right: 0; z-index: 1000;">
                        <div class="card-body p-2">
                            {% if request.user == comment.author or request.user.is_superuser %}
                                <h6><a href="{% url 'delete-comments' story.pk comment.pk %}" class="dropdown-item text-danger">Delete</a></h6>
                            {% endif %}
                            <h6><a href="{% url 'report-comments' story.pk comment.pk %}" class="dropdown-item">Report</a></h6>
                        </div>
                    </div>

                    <div style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <strong><a href="{% url 'user-profile' comment.author.username %}">@{{ comment.author }}:</a></strong>
                        {{ comment.content }}
                        <form method="post" action="{% url 'likes-comments' story.pk comment.pk %}"
                              style="display:inline; font-weight: normal; font-size: 1rem; color: #666;">
                            {{ comment.liked_by.all|length }}
                            {% csrf_token %}
                            <button type="submit" style="border:none; background:none;">
                                {% if user.profile in comment.liked_by.all %}
                                    <img src="{% static 'assets/red-heart-icon-shape-illustration-free-vector.jpg' %}" width="16" height="16" alt="Liked">
                                {% else %}
                                    <img src="{% static 'assets/free-heart-icon-3510-thumb.png' %}" width="16" height="16" alt="Like">
                                {% endif %}
                            </button>
                        </form>
                    </div>

                    <div class="mt-2">
                        <a href="javascript:void(0);" onclick="toggleVisibility('reply-form-{{ comment.id }}')" class="me-2">Reply</a>
                        {% if comment.replies.count > 0 %}
                            <a href="javascript:void(0);" onclick="toggleVisibility('replies-{{ comment.id }}')">| Show replies</a>
                        {% endif %}
                    </div>

                    <!-- Reply Form -->
                    <div id="reply-form-{{ comment.id }}" style="display:none; margin-top: 1rem;">
                        <form method="post" action="{% url 'reply' story.pk comment.pk %}?next=story-detail">
                            {% csrf_token %}
                            <textarea name="content" rows="3" cols="50" placeholder="Write your reply here..." class="form-control"></textarea>
                            <button type="submit" class="btn btn-sm btn-primary mt-2">Submit Reply</button>
                        </form>
                    </div>

                    <!-- Replies -->
                    <div id="replies-{{ comment.id }}" style="display:none; margin-top: 1rem;">
                        {% for reply in comment.replies.all %}
                            <div class="card mb-2 p-2 position-relative" style="margin-left: 1rem;">
                                <button onclick="toggleOptions('{{ reply.pk }}')" class="btn btn-sm btn-light"
                                        style="position: absolute; top: 0.5rem; right: 0.5rem;">⋯</button>

                                <div id="optionsCard-{{ reply.pk }}" class="card shadow mt-2"
                                     style="width: 150px; display: none; position: absolute; top: 2.5rem; right: 0; z-index: 1000;">
                                    <div class="card-body p-2">
                                        {% if request.user == reply.author or request.user.is_superuser %}
                                            <h6><a href="{% url 'delete-comments' story.pk reply.pk %}" class="dropdown-item text-danger">Delete</a></h6>
                                        {% endif %}
                                        <h6><a href="{% url 'report-comments' story.pk reply.pk %}" class="dropdown-item">Report</a></h6>
                                    </div>
                                </div>

                                <div style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <strong><a href="{% url 'user-profile' reply.author.username %}">@{{ reply.author }}:</a></strong>
                                    {{ reply.content }}
                                    <form method="post" action="{% url 'likes-comments' story.pk reply.pk %}"
                                          style="display:inline; font-weight: normal; font-size: 1rem; color: #666;">
                                        {{ reply.liked_by.all|length }}
                                        {% csrf_token %}
                                        <button type="submit" style="border:none; background:none;">
                                            {% if user.profile in reply.liked_by.all %}
                                                <img src="{% static 'assets/red-heart-icon-shape-illustration-free-vector.jpg' %}" width="16" height="16" alt="Liked">
                                            {% else %}
                                                <img src="{% static 'assets/free-heart-icon-3510-thumb.png' %}" width="16" height="16" alt="Like">
                                            {% endif %}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}

            {% if comments|length > 3 %}
                <a href="{% url 'comment-page' story.id %}" class="ms-2 text-muted" style="font-size: 1.2rem;">View More</a>
            {% endif %}
        {% else %}
            <p>Be the first to comment.</p>
        {% endif %}

        <!-- New Comment Form -->
        <form method="post" action="" class="mt-4">
            {% csrf_token %}
            <textarea name="content" rows="3" class="form-control mb-2" placeholder="Share your thoughts..."></textarea>
            <button type="submit" class="btn btn-primary">Post</button>
        </form>
    </div>
</div>

<script>
    function goToChapter(select) {
        const chapterId = select.value;
        if (chapterId) {
            const url = new URL(window.location.href);
            url.searchParams.set('chapter', chapterId);
            window.location.href = url.toString();
        }
    }

    function toggleOptions(pk) {
        const el = document.getElementById(`optionsCard-${pk}`);
        el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none";
    }

    function toggleVisibility(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none";
    }
</script>

{% endblock %}
